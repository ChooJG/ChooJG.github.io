<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë©˜í† ë§ ë°ì´í„° ì²˜ë¦¬ê¸°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 100%;
            text-align: center;
        }

        .title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 40px;
            line-height: 1.6;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 20px;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: rgba(102, 126, 234, 0.05);
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4rem;
            color: #667eea;
            margin-bottom: 20px;
            display: block;
        }

        .upload-text {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
        }

        .upload-subtext {
            font-size: 1rem;
            color: #666;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .progress-container {
            display: none;
            margin-top: 30px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .progress-text {
            font-size: 1rem;
            color: #333;
            font-weight: 500;
        }

        .result-container {
            display: none;
            margin-top: 30px;
            padding: 25px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 15px;
            border-left: 5px solid #667eea;
        }

        .result-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
        }

        .result-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: #667eea;
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        .download-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .error-message {
            color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #dc3545;
            display: none;
        }

        .tab-list {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            text-align: left;
            max-height: 300px;
            overflow-y: auto;
        }

        .tab-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }

        .tab-item:last-child {
            border-bottom: none;
        }

        .tab-name {
            font-weight: 500;
            color: #333;
        }

        .tab-count {
            color: #666;
            font-size: 0.8rem;
        }

        .anomaly-tab {
            background-color: #fff3cd;
            border-left: 3px solid #ffc107;
            padding-left: 5px;
        }

        .anomaly-info {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
            text-align: left;
            font-size: 0.9rem;
            color: #856404;
        }

        .new-upload-btn {
            background: linear-gradient(45deg, #6c757d, #5a6268);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }

        .new-upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(108, 117, 125, 0.4);
        }

        @media (max-width: 600px) {
            .container {
                padding: 30px 20px;
                margin: 10px;
            }
            
            .title {
                font-size: 2rem;
            }
            
            .upload-area {
                padding: 40px 15px;
            }
            
            .result-stats {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">ë©˜í† ë§ ë°ì´í„° ì²˜ë¦¬ê¸°</h1>
        <p class="subtitle">ì›ë³¸ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ì§€ì—­/í•™êµê¸‰/ì›”ë³„ë¡œ ì •ë¦¬ëœ íŒŒì¼ê³¼ í™œë™ë¹„ ê³„ì‚°ì„œë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•´ë“œë¦½ë‹ˆë‹¤.</p>
        
        <div class="upload-area" id="uploadArea">
            <span class="upload-icon">ğŸ“Š</span>
            <div class="upload-text">ì—‘ì…€ íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë¡­í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</div>
            <div class="upload-subtext">.xlsx, .xls íŒŒì¼ë§Œ ì§€ì›ë©ë‹ˆë‹¤</div>
            <button class="upload-btn">
                íŒŒì¼ ì„ íƒí•˜ê¸°
            </button>
            <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls" />
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">ì²˜ë¦¬ ì¤‘...</div>
        </div>

        <div class="result-container" id="resultContainer">
            <div class="result-title">ì²˜ë¦¬ ì™„ë£Œ!</div>
            <div class="result-stats" id="resultStats"></div>
            <div class="anomaly-info" id="anomalyInfo" style="display: none;"></div>
            <div class="tab-list" id="tabList"></div>
            <button class="download-btn" id="downloadBtn">
                ğŸ“¥ ì •ë¦¬ëœ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
            </button>
            <button class="new-upload-btn" id="newUploadBtn">
                ğŸ“ ìƒˆ íŒŒì¼ ì—…ë¡œë“œ
            </button>
        </div>

        <div class="error-message" id="errorMessage"></div>
    </div>

    <script>
        let processedWorkbook = null;
        
        // íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸ ì„¤ì •
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const progressContainer = document.getElementById('progressContainer');
        const resultContainer = document.getElementById('resultContainer');
        const errorMessage = document.getElementById('errorMessage');

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê¸°ëŠ¥
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                showError('Excel íŒŒì¼(.xlsx, .xls)ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }

            hideError();
            showProgress();
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    processExcelFile(e.target.result);
                } catch (error) {
                    console.error('íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                    showError('íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                    hideProgress();
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function processExcelFile(arrayBuffer) {
            updateProgress(20, 'íŒŒì¼ ì½ëŠ” ì¤‘...');
            
            // Excel íŒŒì¼ ì½ê¸°
            const workbook = XLSX.read(arrayBuffer, { type: 'array' });
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            
            updateProgress(40, 'ë°ì´í„° íŒŒì‹± ì¤‘...');
            
            // JSONìœ¼ë¡œ ë³€í™˜
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            
            updateProgress(60, 'ë°ì´í„° ì •ë¦¬ ì¤‘...');
            
            // ë°ì´í„° ì²˜ë¦¬ ë° ê·¸ë£¹í•‘
            const processedData = processData(jsonData);
            
            updateProgress(80, 'ì—‘ì…€ íŒŒì¼ ìƒì„± ì¤‘...');
            
            // ìƒˆ ì›Œí¬ë¶ ìƒì„±
            processedWorkbook = createProcessedWorkbook(processedData);
            
            updateProgress(100, 'ì™„ë£Œ!');
            
            // ê²°ê³¼ í‘œì‹œ
            setTimeout(() => {
                hideProgress();
                showResults(processedData);
            }, 500);
        }

        // í•™êµëª…ì´ ì •ìƒì¸ì§€ ì²´í¬í•˜ëŠ” í•¨ìˆ˜
        function isValidSchoolName(schoolName) {
            if (!schoolName || schoolName.trim() === '') {
                return false;
            }
            
            const school = String(schoolName).trim();
            
            // ê³¼ëª© ê´€ë ¨ í‚¤ì›Œë“œ ì²´í¬
            const subjectKeywords = ['êµ­ì–´', 'ì˜ì–´', 'ìˆ˜í•™', 'ê³¼í•™', 'ì‚¬íšŒ', 'ì—­ì‚¬', 'ë¬¼ë¦¬', 'í™”í•™', 'ìƒë¬¼', 
                                    'ì§€êµ¬ê³¼í•™', 'ì •ë³´', 'ê¸°ìˆ ', 'ê°€ì •', 'ë¯¸ìˆ ', 'ìŒì•…', 'ì²´ìœ¡', 'ë„ë•', 
                                    'ìœ¤ë¦¬', 'í•œë¬¸', 'ì¼ë³¸ì–´', 'ì¤‘êµ­ì–´', 'í”„ë‘ìŠ¤ì–´', 'ë…ì¼ì–´', 'ìŠ¤í˜ì¸ì–´'];
            
            // ê³¼ëª© í‚¤ì›Œë“œë§Œ ìˆê³  í•™êµ í‚¤ì›Œë“œê°€ ì—†ëŠ” ê²½ìš°
            const hasSubject = subjectKeywords.some(subject => school.includes(subject));
            const hasSchoolKeyword = school.includes('í•™êµ') || school.includes('ê³ ë“±') || school.includes('ì¤‘í•™') || 
                                    school.includes('ì´ˆë“±') || school.includes('ëŒ€í•™');
            
            // ê³¼ëª©ëª…ë§Œ ìˆê±°ë‚˜ ë¹ˆê°’ì¸ ê²½ìš° false ë°˜í™˜
            if (hasSubject && !hasSchoolKeyword) {
                return false;
            }
            
            // í•™êµ í‚¤ì›Œë“œê°€ í•˜ë‚˜ë„ ì—†ëŠ” ê²½ìš°ë„ ì´ìƒì¹˜ë¡œ ì²˜ë¦¬
            if (!hasSchoolKeyword) {
                return false;
            }
            
            return true;
        }

        function processData(data) {
            const groupedData = {};
            let totalRows = 0;
            let anomalyCount = 0;

            data.forEach(row => {
                try {
                    // í•™êµëª… ì²´í¬ (ë©˜í‹° ì¶”ê°€ì •ë³´1 í•„ë“œ ì‚¬ìš©)
                    const schoolInfo = row['ë©˜í‹° ì¶”ê°€ì •ë³´1'];
                    const isValidSchool = isValidSchoolName(schoolInfo);

                    const mentorTime = row['ë©˜í†  ì²´ë¥˜ì‹œê°„(ë¶„)'];
                    const menteeTime = row['ë©˜í‹° ì²´ë¥˜ì‹œê°„(ë¶„)'];
                    const isValidTime = isValidTimeData(mentorTime, menteeTime);
                    
                    // ì´ìƒì¹˜ ë°ì´í„°ëŠ” ë³„ë„ íƒ­ìœ¼ë¡œ
                    if (!isValidSchool || !isValidTime) {
                        const tabName = 'ì´ìƒì¹˜';
                        
                        if (!groupedData[tabName]) {
                            groupedData[tabName] = [];
                        }
                        
                        // ì¸ì • ê°’ ê³„ì‚°
                        const tutorStayTime = parseInt(row['ë©˜í†  ì²´ë¥˜ì‹œê°„(ë¶„)']) || 0;
                        const feedback = row['ë©˜í† ì˜ ë©˜í‹° í”¼ë“œë°±'] || '';
                        const recognition = calculateRecognition(tutorStayTime, feedback);
                        
                        // ë°ì´í„° ì •ë¦¬
                        const processedRow = {
                            'ë©˜í† ': row['ë©˜í† ëª…'] || '',
                            'ë©˜í‹°': row['ë©˜í‹° ì´ë¦„'] || '',
                            'í•™êµì •ë³´(ì›ë³¸)': schoolInfo || '(ë¹ˆê°’)',
                            'ìˆ˜ì—…ì¼': row['ì‹œì‘ì¼ì(í‰ê°€ì¼ì‹œ)'] || '',
                            'ì‹œì‘ì‹œê°„': row['ì‹œì‘ì‹œê°„'] || '',
                            'ì¢…ë£Œì‹œê°„': row['ì¢…ë£Œì‹œê°„'] || '',
                            'ìˆ˜ì—…ì‹œê°„': row['ìˆ˜ì—…ì§„í–‰ ì‹œê°„(ë¶„)'] || '',
                            'íŠœí„°ì²´ë¥˜ì‹œê°„': row['ë©˜í†  ì²´ë¥˜ì‹œê°„(ë¶„)'] || '',
                            'íŠœí‹°ì²´ë¥˜ì‹œê°„': row['ë©˜í‹° ì²´ë¥˜ì‹œê°„(ë¶„)'] || '',
                            'ì¸ì •': recognition,
                            'í”¼ë“œë°±': row['ë©˜í† ì˜ ë©˜í‹° í”¼ë“œë°±'] || '',
                            'ì™„ë£Œë³´ê³ ': row['ê°•ì˜ ë³´ê³ ì„œ'] || '',
                            'ê¸°íƒ€': '',
                            'ê¸°íƒ€2': '',
                            'ì¦ë¹™': '',
                            'ë¬¸ì œí’€ì´ ìˆ˜': row['ë©˜í‹° ë¬¸ì œ í’€ì´ ìˆ˜'] || '',
                            'ì •ë‹µ ìˆ˜': row['ë©˜í‹° ì •ë‹µ ìˆ˜'] || ''
                        };
                        
                        groupedData[tabName].push(processedRow);
                        anomalyCount++;
                    } else {
                        // ì •ìƒ ë°ì´í„° ì²˜ë¦¬
                        // ì§€ì—­ ì¶”ì¶œ (ì˜ˆ: "ì²­ì–‘êµ°" -> "ì²­ì–‘")
                        const region = row['ì§€ì—­ êµ¬ë¶„'] ? row['ì§€ì—­ êµ¬ë¶„'].replace('êµ°', '').replace('ì‹œ', '') : 'ê¸°íƒ€';
                        
                        // í•™êµê¸‰ êµ¬ë¶„
                        const schoolType = String(schoolInfo).includes('ì¤‘') ? 'ì¤‘ë“±' : 'ê³ ë“±';
                        
                        // ì›” ì¶”ì¶œ
                        const startDate = new Date(row['ì‹œì‘ì¼ì(í‰ê°€ì¼ì‹œ)']);
                        const month = startDate.getMonth() + 1;
                        
                        // íƒ­ ì´ë¦„ ìƒì„±
                        const tabName = `${region}(${schoolType}) ${month}ì›”`;
                        
                        if (!groupedData[tabName]) {
                            groupedData[tabName] = [];
                        }
                        
                        // ì¸ì • ê°’ ê³„ì‚°
                        const tutorStayTime = parseInt(row['ë©˜í†  ì²´ë¥˜ì‹œê°„(ë¶„)']) || 0;
                        const feedback = row['ë©˜í† ì˜ ë©˜í‹° í”¼ë“œë°±'] || '';
                        const recognition = calculateRecognition(tutorStayTime, feedback);
                        
                        // ë°ì´í„° ì •ë¦¬
                        const processedRow = {
                            'ë©˜í† ': row['ë©˜í† ëª…'] || '',
                            'ë©˜í‹°': row['ë©˜í‹° ì´ë¦„'] || '',
                            'ìˆ˜ì—…ì¼': row['ì‹œì‘ì¼ì(í‰ê°€ì¼ì‹œ)'] || '',
                            'ì‹œì‘ì‹œê°„': row['ì‹œì‘ì‹œê°„'] || '',
                            'ì¢…ë£Œì‹œê°„': row['ì¢…ë£Œì‹œê°„'] || '',
                            'ìˆ˜ì—…ì‹œê°„': row['ìˆ˜ì—…ì§„í–‰ ì‹œê°„(ë¶„)'] || '',
                            'íŠœí„°ì²´ë¥˜ì‹œê°„': row['ë©˜í†  ì²´ë¥˜ì‹œê°„(ë¶„)'] || '',
                            'íŠœí‹°ì²´ë¥˜ì‹œê°„': row['ë©˜í‹° ì²´ë¥˜ì‹œê°„(ë¶„)'] || '',
                            'ì¸ì •': recognition,
                            'í”¼ë“œë°±': row['ë©˜í† ì˜ ë©˜í‹° í”¼ë“œë°±'] || '',
                            'ì™„ë£Œë³´ê³ ': row['ê°•ì˜ ë³´ê³ ì„œ'] || '',
                            'ê¸°íƒ€': '',
                            'ê¸°íƒ€2': '',
                            'ì¦ë¹™': '',
                            'ë¬¸ì œí’€ì´ ìˆ˜': row['ë©˜í‹° ë¬¸ì œ í’€ì´ ìˆ˜'] || '',
                            'ì •ë‹µ ìˆ˜': row['ë©˜í‹° ì •ë‹µ ìˆ˜'] || ''
                        };
                        
                        groupedData[tabName].push(processedRow);
                    }
                    
                    totalRows++;
                } catch (error) {
                    console.error('í–‰ ì²˜ë¦¬ ì˜¤ë¥˜:', error, row);
                }
            });
            
            return { groupedData, totalRows, anomalyCount };
        }

        function calculateRecognition(tuteeStayTime, completionReport) {
            if (!completionReport || completionReport.trim() === '' || !tuteeStayTime || tuteeStayTime === '') {
                return 0;
            }
            
            if (tuteeStayTime >= 110) return 2;
            if (tuteeStayTime >= 90) return 1.5;
            if (tuteeStayTime >= 50) return 1;
            if (tuteeStayTime >= 30) return 0.5;
            return 0;
        }

        function createProcessedWorkbook(processedData) {
            const { groupedData } = processedData;
            const workbook = XLSX.utils.book_new();
            
            // ì´ìƒì¹˜ íƒ­ì„ ë¨¼ì € ìƒì„±
            if (groupedData['ì´ìƒì¹˜'] && groupedData['ì´ìƒì¹˜'].length > 0) {
                const worksheet = XLSX.utils.json_to_sheet(groupedData['ì´ìƒì¹˜']);
                XLSX.utils.book_append_sheet(workbook, worksheet, 'ì´ìƒì¹˜');
                
                // ì´ìƒì¹˜ íƒ­ì˜ í™œë™ë¹„ë„ ìƒì„±
                const mentorSummary = {};
                groupedData['ì´ìƒì¹˜'].forEach(row => {
                    const mentor = row['ë©˜í† '];
                    const recognition = parseFloat(row['ì¸ì •']) || 0;
                    
                    if (!mentorSummary[mentor]) {
                        mentorSummary[mentor] = 0;
                    }
                    mentorSummary[mentor] += recognition;
                });
                
                const activityData = Object.keys(mentorSummary).map(mentor => ({
                    'ë©˜í† ': mentor,
                    'ì¸ì •íšŸìˆ˜': mentorSummary[mentor],
                    'ê¸ˆì•¡ (íšŒë‹¹ 20,000)': mentorSummary[mentor] * 20000
                }));
                
                if (activityData.length > 0) {
                    const activitySheet = XLSX.utils.json_to_sheet(activityData);
                    XLSX.utils.book_append_sheet(workbook, activitySheet, 'ì´ìƒì¹˜ - í™œë™ë¹„');
                }
            }
            
            // ë‚˜ë¨¸ì§€ ì •ìƒ íƒ­ë“¤ ìƒì„±
            Object.keys(groupedData).forEach(tabName => {
                if (tabName !== 'ì´ìƒì¹˜') {
                    const worksheet = XLSX.utils.json_to_sheet(groupedData[tabName]);
                    XLSX.utils.book_append_sheet(workbook, worksheet, tabName);
                }
            });
            
            // ì •ìƒ íƒ­ë“¤ì˜ í™œë™ë¹„ íƒ­ ìƒì„±
            Object.keys(groupedData).forEach(tabName => {
                if (tabName !== 'ì´ìƒì¹˜') {
                    const mentorSummary = {};
                    
                    // ë©˜í† ë³„ ì¸ì •íšŸìˆ˜ í•©ê³„ ê³„ì‚°
                    groupedData[tabName].forEach(row => {
                        const mentor = row['ë©˜í† '];
                        const recognition = parseFloat(row['ì¸ì •']) || 0;
                        
                        if (!mentorSummary[mentor]) {
                            mentorSummary[mentor] = 0;
                        }
                        mentorSummary[mentor] += recognition;
                    });
                    
                    // í™œë™ë¹„ ë°ì´í„° ìƒì„±
                    const activityData = Object.keys(mentorSummary).map(mentor => ({
                        'ë©˜í† ': mentor,
                        'ì¸ì •íšŸìˆ˜': mentorSummary[mentor],
                        'ê¸ˆì•¡ (íšŒë‹¹ 20,000)': mentorSummary[mentor] * 20000
                    }));
                    
                    if (activityData.length > 0) {
                        const activitySheet = XLSX.utils.json_to_sheet(activityData);
                        XLSX.utils.book_append_sheet(workbook, activitySheet, `${tabName} - í™œë™ë¹„`);
                    }
                }
            });
            
            return workbook;
        }

        function showResults(processedData) {
            const { groupedData, totalRows, anomalyCount } = processedData;
            
            // í†µê³„ í‘œì‹œ
            const tabCount = Object.keys(groupedData).length;
            const normalTabCount = tabCount - (groupedData['ì´ìƒì¹˜'] ? 1 : 0);
            const activityTabCount = tabCount; // í™œë™ë¹„ íƒ­ ê°œìˆ˜ëŠ” ê¸°ë³¸ íƒ­ê³¼ ë™ì¼
            const totalTabs = tabCount * 2; // ê¸°ë³¸ íƒ­ + í™œë™ë¹„ íƒ­
            
            document.getElementById('resultStats').innerHTML = `
                <div class="stat-item">
                    <span class="stat-number">${totalRows}</span>
                    <div class="stat-label">ì´ ë°ì´í„°</div>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${normalTabCount}</span>
                    <div class="stat-label">ì •ìƒ íƒ­</div>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${anomalyCount}</span>
                    <div class="stat-label">ì´ìƒì¹˜ ë°ì´í„°</div>
                </div>
                <div class="stat-item">
                    <span class="stat-number">${totalTabs}</span>
                    <div class="stat-label">ì „ì²´ íƒ­</div>
                </div>
            `;
            
            // ì´ìƒì¹˜ ì •ë³´ í‘œì‹œ
            if (anomalyCount > 0) {
                const anomalyInfo = document.getElementById('anomalyInfo');
                anomalyInfo.innerHTML = `
                    âš ï¸ <strong>ì´ìƒì¹˜ ë°ì´í„° ${anomalyCount}ê±´ ë°œê²¬</strong><br>
                    í•™êµëª… ì˜¤ë¥˜ ë˜ëŠ” ë©˜í‹° ì‹œê°„ì´ ë©˜í†  ì‹œê°„ë³´ë‹¤ 10ë¶„ ì´ˆê³¼í•œ ë°ì´í„°ë¥¼ 'ì´ìƒì¹˜' íƒ­ìœ¼ë¡œ ë¶„ë¦¬í–ˆìŠµë‹ˆë‹¤.
                `;
                anomalyInfo.style.display = 'block';
            }
            
            // íƒ­ ëª©ë¡ í‘œì‹œ
            let tabListHTML = '';
            
            // ì´ìƒì¹˜ íƒ­ì„ ë¨¼ì € í‘œì‹œ
            if (groupedData['ì´ìƒì¹˜']) {
                const count = groupedData['ì´ìƒì¹˜'].length;
                tabListHTML += `
                    <div class="tab-item anomaly-tab">
                        <span class="tab-name">âš ï¸ ì´ìƒì¹˜</span>
                        <span class="tab-count">${count}ê°œ ë°ì´í„°</span>
                    </div>
                `;
            }
            
            // ì •ìƒ íƒ­ë“¤ í‘œì‹œ
            Object.keys(groupedData).forEach(tabName => {
                if (tabName !== 'ì´ìƒì¹˜') {
                    const count = groupedData[tabName].length;
                    tabListHTML += `
                        <div class="tab-item">
                            <span class="tab-name">${tabName}</span>
                            <span class="tab-count">${count}ê°œ ë°ì´í„°</span>
                        </div>
                        <div class="tab-item">
                            <span class="tab-name">${tabName} - í™œë™ë¹„</span>
                            <span class="tab-count">ë©˜í† ë³„ í™œë™ë¹„</span>
                        </div>
                    `;
                }
            });
            
            document.getElementById('tabList').innerHTML = tabListHTML;
            
            resultContainer.style.display = 'block';
        }

        // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('downloadBtn').addEventListener('click', () => {
            if (processedWorkbook) {
                const today = new Date();
                const dateStr = today.getFullYear() + '-' + 
                               String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                               String(today.getDate()).padStart(2, '0');
                
                XLSX.writeFile(processedWorkbook, `ë©˜í† ë§_ì •ë¦¬_ë°ì´í„°_${dateStr}.xlsx`);
            }
        });

        // ìƒˆ íŒŒì¼ ì—…ë¡œë“œ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('newUploadBtn').addEventListener('click', () => {
            // ëª¨ë“  ìƒíƒœ ì´ˆê¸°í™”
            uploadArea.style.display = 'block';
            resultContainer.style.display = 'none';
            hideError();
            hideProgress();
            fileInput.value = '';
            processedWorkbook = null;
            document.getElementById('anomalyInfo').style.display = 'none';
        });

        function showProgress() {
            progressContainer.style.display = 'block';
            resultContainer.style.display = 'none';
        }

        function hideProgress() {
            progressContainer.style.display = 'none';
        }

        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
       }

       function showError(message) {
           errorMessage.textContent = message;
           errorMessage.style.display = 'block';
           resultContainer.style.display = 'none';
       }

       function hideError() {
           errorMessage.style.display = 'none';
       }

       // ì‹œê°„ ë°ì´í„°ê°€ ì •ìƒì¸ì§€ ì²´í¬í•˜ëŠ” í•¨ìˆ˜
        function isValidTimeData(mentorTime, menteeTime) {
            const mentorMinutes = parseInt(mentorTime) || 0;
            const menteeMinutes = parseInt(menteeTime) || 0;
            
            // ë©˜í‹° ì‹œê°„ì´ ë©˜í†  ì‹œê°„ë³´ë‹¤ 10ë¶„ ì´ˆê³¼í•˜ë©´ ì´ìƒì¹˜
            if (menteeMinutes > mentorMinutes + 10) {
                return false;
            }
            
            return true;
        }
   </script>
</body>
</html>